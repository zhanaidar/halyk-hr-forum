<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ - Halyk HR Forum</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1DB584 0%, #0a7d5a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        #root {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #1DB584;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .competencies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .competency-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .competency-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
        }

        .competency-card.not-started {
            border: 3px solid #e0e0e0;
        }

        .competency-card.in-progress {
            border: 3px solid #ffa726;
            background: linear-gradient(135deg, #fff 0%, #fff8e1 100%);
        }

        .competency-card.completed {
            border: 3px solid #1DB584;
            background: linear-gradient(135deg, #fff 0%, #e8f5f1 100%);
        }

        .status-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.not-started {
            background: #f5f5f5;
            color: #666;
        }

        .status-badge.in-progress {
            background: #ffa726;
            color: white;
        }

        .status-badge.completed {
            background: #1DB584;
            color: white;
        }

        .competency-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-right: 80px;
        }

        .score {
            font-size: 32px;
            font-weight: 700;
            color: #1DB584;
            margin: 16px 0;
        }

        .level {
            display: inline-block;
            padding: 8px 16px;
            background: #1DB584;
            color: white;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .back-btn {
            background: white;
            color: #1DB584;
            border: 2px solid #1DB584;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: #1DB584;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: white;
            font-size: 20px;
        }

        .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [competencies, setCompetencies] = useState([]);
            const [loading, setLoading] = useState(true);
            
            const urlParams = new URLSearchParams(window.location.search);
            const profileId = urlParams.get('profile_id');

            useEffect(() => {
                loadCompetencies();
                
                // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                const handleVisibilityChange = () => {
                    if (!document.hidden) {
                        loadCompetencies();
                    }
                };
                
                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
            }, []);

            const loadCompetencies = async () => {
                const token = localStorage.getItem('halyk_token');
                if (!token) {
                    window.location.href = '/';
                    return;
                }
                
                try {
                    const response = await fetch(`/api/competencies/${profileId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.status === 401) {
                        localStorage.clear();
                        window.location.href = '/';
                        return;
                    }
                    
                    const data = await response.json();
                    setCompetencies(data.competencies);
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π');
                } finally {
                    setLoading(false);
                }
            };

            const getStatusText = (status) => {
                switch(status) {
                    case 'not_started': return '–ù–µ –Ω–∞—á–∞—Ç–æ';
                    case 'in_progress': return '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                    case 'completed': return '–ó–∞–≤–µ—Ä—à–µ–Ω–æ';
                    default: return '';
                }
            };

            const getStatusIcon = (status) => {
                switch(status) {
                    case 'not_started': return 'üîí';
                    case 'in_progress': return '‚è≥';
                    case 'completed': return '‚úÖ';
                    default: return '';
                }
            };

            const getLevel = (score, maxScore) => {
                if (score >= 5) return 'Senior';
                if (score >= 3) return 'Middle';
                return 'Junior';
            };

            const handleCompetencyClick = async (comp) => {
                if (comp.status === 'completed') {
                    window.location.href = `/results?user_test_id=${comp.user_test_id}`;
                } else {
                    const token = localStorage.getItem('halyk_token');
                    
                    try {
                        const response = await fetch('/api/start-test', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                competency_id: comp.id
                            })
                        });
                        
                        const data = await response.json();
                        window.location.href = `/test?user_test_id=${data.user_test_id}`;
                    } catch (error) {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞');
                    }
                }
            };

            if (loading) {
                return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π...</div>;
            }

            return (
                <div>
                    <button className="back-btn" onClick={() => window.location.href = '/'}>
                        ‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º
                    </button>

                    <div className="header">
                        <h1>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—é</h1>
                        <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</p>
                    </div>

                    <div className="competencies-grid">
                        {competencies.map(comp => (
                            <div
                                key={comp.id}
                                className={`competency-card ${comp.status}`}
                                onClick={() => handleCompetencyClick(comp)}
                            >
                                <span className={`status-badge ${comp.status}`}>
                                    {getStatusText(comp.status)}
                                </span>
                                
                                <div className="icon">{getStatusIcon(comp.status)}</div>
                                
                                <div className="competency-name">{comp.name}</div>

                                {comp.status === 'completed' && (
                                    <>
                                        <div className="score">{comp.score}/{comp.max_score}</div>
                                        <span className="level">{getLevel(comp.score, comp.max_score)}</span>
                                    </>
                                )}

                                {comp.status === 'in_progress' && (
                                    <p style={{color: '#ff9800', fontWeight: 600}}>
                                        –¢–µ—Å—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω
                                    </p>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>