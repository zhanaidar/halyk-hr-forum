<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Panel - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #1DB584;
            font-size: 24px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .table-item {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .table-header {
            background: #f8f9fa;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .table-header:hover {
            background: #e9ecef;
        }

        .table-header h3 {
            color: #1DB584;
            font-size: 18px;
        }

        .table-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .table-content.open {
            max-height: 1000px;
        }

        .table-content table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-content th,
        .table-content td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table-content th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .table-content td {
            color: #666;
            font-size: 14px;
        }

        .sql-section textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }

        .sql-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #1DB584;
            color: white;
        }

        .btn-primary:hover {
            background: #16a073;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .sql-result {
            margin-top: 20px;
            overflow-x: auto;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .arrow {
            transition: transform 0.3s;
        }

        .arrow.open {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê HR Panel - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h1>
        <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>

    <div class="container">
        <!-- –¢–∞–±–ª–∏—Ü—ã –ë–î -->
        <div class="section">
            <h2>üìÅ –¢–∞–±–ª–∏—Ü—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫)</h2>
            <div id="tables-container"></div>
        </div>

        <!-- SQL –∫–æ–Ω—Å–æ–ª—å -->
        <div class="section sql-section">
            <h2>üíª SQL –ö–æ–Ω—Å–æ–ª—å</h2>
            <textarea id="sqlQuery" placeholder="SELECT * FROM users LIMIT 10"></textarea>
            <div class="sql-buttons">
                <button class="btn btn-primary" onclick="executeSQL()">‚ñ∂ –í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="clearSQL()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="exportToCSV()" id="exportBtn" style="display:none">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
            </div>
            <div class="error-message" id="sqlError"></div>
            <div class="sql-result" id="sqlResult"></div>
        </div>
    </div>

    <script>


        let tablesData = {};
        let lastQueryResult = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

        async function loadTables() {
            try {
                const response = await fetch('/api/hr/tables');
                tablesData = await response.json();
                renderTables();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü:', error);
            }
        }

        function renderTables() {
            const container = document.getElementById('tables-container');
            const tableNames = Object.keys(tablesData);

            container.innerHTML = tableNames.map(tableName => `
                <div class="table-item">
                    <div class="table-header" onclick="toggleTable('${tableName}')">
                        <h3>üìä ${tableName}</h3>
                        <span class="arrow" id="arrow-${tableName}">‚ñº</span>
                    </div>
                    <div class="table-content" id="content-${tableName}">
                        ${renderTable(tableName)}
                    </div>
                </div>
            `).join('');
        }

        function renderTable(tableName) {
            const data = tablesData[tableName];
            if (!data || !data.rows || data.rows.length === 0) {
                return '<p style="padding: 20px; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
            }

            return `
                <table>
                    <thead>
                        <tr>
                            ${data.columns.map(col => `<th>${col}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.rows.map(row => `
                            <tr>
                                ${row.map(cell => `<td>${cell !== null ? cell : 'NULL'}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function toggleTable(tableName) {
            const content = document.getElementById(`content-${tableName}`);
            const arrow = document.getElementById(`arrow-${tableName}`);
            
            content.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        async function executeSQL() {
            const query = document.getElementById('sqlQuery').value.trim();
            const errorDiv = document.getElementById('sqlError');
            const resultDiv = document.getElementById('sqlResult');

            if (!query) {
                errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ SQL –∑–∞–ø—Ä–æ—Å';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            resultDiv.innerHTML = '<p style="color: #999;">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...</p>';

            try {
                const response = await fetch('/api/hr/sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail);
                }

                const data = await response.json();

                if (data.rows.length === 0) {
                    resultDiv.innerHTML = '<p style="color: #999; padding: 20px;">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>';
                    document.getElementById('exportBtn').style.display = 'none';
                    return;
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
                lastQueryResult = data;
                document.getElementById('exportBtn').style.display = 'inline-block';

                resultDiv.innerHTML = `
                    <p style="margin-bottom: 15px; color: #1DB584; font-weight: 600;">
                        ‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫: ${data.count}
                    </p>
                    <table>
                        <thead>
                            <tr>
                                ${data.columns.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.rows.map(row => `
                                <tr>
                                    ${row.map(cell => `<td>${cell !== null ? cell : 'NULL'}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        function clearSQL() {
            document.getElementById('sqlQuery').value = '';
            document.getElementById('sqlResult').innerHTML = '';
            document.getElementById('sqlError').style.display = 'none';
        }

        function exportToCSV() {
            if (!lastQueryResult) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º CSV
            let csv = '';
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            csv += lastQueryResult.columns.join(',') + '\n';
            
            // –î–∞–Ω–Ω—ã–µ
            lastQueryResult.rows.forEach(row => {
                const escapedRow = row.map(cell => {
                    if (cell === null) return 'NULL';
                    const str = String(cell);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                });
                csv += escapedRow.join(',') + '\n';
            });

            // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª —Å BOM –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –≤ Excel
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `export_${Date.now()}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function logout() {
            await fetch('/api/hr/logout', {
                method: 'POST',
                credentials: 'include'
            });
            window.location.href = '/hr';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadTables();
    </script>
</body>
</html>